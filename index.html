<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <title>WebAR Solar System</title>

  <!-- A-Frame & AR.js -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/ar.js/aframe/build/aframe-ar.min.js"></script>
  <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
  <script src="https://unpkg.com/aframe-particle-system-component@1.0.9/dist/aframe-particle-system-component.min.js"></script>
</head>

<body style="margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh;">
  <button id="startAR" style="padding: 15px 30px; font-size: 16px; cursor: pointer;">Start AR Experience</button>

  <div id="arContainer" style="display: none; width: 100%; height: 100%;">
    <a-scene embedded arjs="sourceType: webcam;">
      <a-assets>
        <a-asset-item id="solarModel" src="post.glb"></a-asset-item>
        <img id="sunTexture" src="sun2.jpg" />
      </a-assets>

      <!-- 🌌 Sky -->
      <a-sky color="#000000"></a-sky>

      <!-- ☄️ Asteroid -->
      <a-entity id="asteroid"
        geometry="primitive: sphere; radius: 0.5"
        material="color: #ff7700; emissive: #ff2200; emissiveIntensity: 2; shader: standard"
        position="-3 2 -5"
        particle-system="preset: dust; particleCount: 500; color: #ffaa00, #ff5500; size: 0.2; opacity: 0.7"
        animation__fly="property: position; to: 3 3 -30; dur: 3000; easing: easeInOutSine; startEvents: fly"
        animation__fadeout="property: material.opacity; to: 0; dur: 1000; startEvents: fly"
        animation__rotate="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true">
      </a-entity>

      <!-- 🌞 Sun -->
      <a-entity id="sun"
        geometry="primitive: sphere; radius: 1.2"
        material="src: #sunTexture; shader: standard; emissiveIntensity: 1"
        position="0 2 -30"
        visible="false"
        animation__fadein="property: visible; to: true; delay: 10; dur: 10; startEvents: fadeInSolar">
      </a-entity>

      <!-- 🌍 Solar System Model -->
      <a-entity id="solarSystem"
        gltf-model="#solarModel"
        animation-mixer
        position="0 2 -30"
        scale="0.5 0.5 0.5"
        gesture-controls
        visible="false"
        animation__fadein="property: visible; to: true; delay: 10; dur: 10; startEvents: fadeInSolar">
      </a-entity>

      <!-- 🎥 Camera -->
      <a-camera position="1 5 5" rotation="-30 -45 0" look-controls>
        <a-cursor></a-cursor>
      </a-camera>
    </a-scene>
  </div>

  <script>
    // 📌 Start AR on Button Click
    document.getElementById('startAR').addEventListener('click', async function () {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        if (stream) {
          document.getElementById('startAR').style.display = 'none';
          document.getElementById('arContainer').style.display = 'block';
        }
      } catch (err) {
        alert("Camera permission denied. Please allow access to use AR.");
      }
    });

    // ☄️ Asteroid click triggers intro + fade-in
    const asteroid = document.querySelector("#asteroid");
    setTimeout(() => {
      asteroid.emit("fly");
      setTimeout(() => {
        document.querySelector("#solarSystem").emit("fadeInSolar");
        document.querySelector("#sun").emit("fadeInSolar");
        speak("A spark from the void awakens the Celestial Classroom...");
      }, 3000);
    }, 2000); // starts 2 seconds after scene loads


    // 🎙️ Narration
    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "en-US";
      utterance.rate = 1;
      speechSynthesis.speak(utterance);
    }

    // 🧠 Planet Tap-to-Speak
    AFRAME.registerComponent("planet-speech", {
      init: function () {
        let el = this.el;
        el.addEventListener("model-loaded", function () {
          let model = el.getObject3D("mesh");
          if (!model) return;

          el.addEventListener("click", function (event) {
            let clickedPlanet = event.detail.intersection.object;
            let planetName = getPlanetName(clickedPlanet);
            if (planetName) {
              speak(planetDescriptions[planetName] || "I am a mysterious celestial body.");

              const planetGroup = clickedPlanet.parent;
              const originalScale = planetGroup.scale.clone();

              const tempEntity = document.createElement("a-entity");
              tempEntity.setAttribute("scale", originalScale);
              planetGroup.add(tempEntity.object3D);

              tempEntity.setAttribute("animation__zoom", {
                property: "scale",
                to: `${originalScale.x * 1.3} ${originalScale.y * 1.3} ${originalScale.z * 1.3}`,
                dur: 200,
                easing: "easeOutQuad",
                autoplay: true
              });

              setTimeout(() => {
                tempEntity.setAttribute("animation__zoomOut", {
                  property: "scale",
                  to: `${originalScale.x} ${originalScale.y} ${originalScale.z}`,
                  dur: 200,
                  easing: "easeInQuad",
                  autoplay: true
                });
              }, 300);
            }
          });
        });
      }
    });

    const planetDescriptions = {
      Sun: "I am the Sun, the heart of the Solar System. I provide light and warmth to all the planets!",
      Mercury: "I am Mercury, the closest planet to the Sun. I am small but incredibly fast!",
      Venus: "I am Venus, the hottest planet in the solar system, covered with thick clouds!",
      Earth: "Hello! I am Earth, your home planet. The only planet known to support life.",
      Mars: "I am Mars, also called the Red Planet. Scientists are searching for signs of life here.",
      Jupiter: "I am Jupiter, the biggest planet in the solar system. My Great Red Spot is a giant storm!",
      Saturn: "I am Saturn, famous for my beautiful rings made of ice and rock!",
      Uranus: "I am Uranus. I rotate on my side and I am a frozen gas giant!",
      Neptune: "I am Neptune, the farthest planet from the Sun. My winds are the fastest in the Solar System!"
    };

    function getPlanetName(object) {
      while (object) {
        if (planetDescriptions[object.name]) {
          return object.name;
        }
        object = object.parent;
      }
      return null;
    }

    document.querySelector("#solarSystem").setAttribute("planet-speech", "");
  </script>
</body>
</html>
